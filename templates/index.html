<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chad Meeting ‚Äî 1 —É—á–∞—Å—Ç–Ω–∏–∫</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="header">
            <div class="room-info">
                <h2>Chad Meeting</h2>
                <span class="participants-count" id="participants-count">‚Äî 1 —É—á–∞—Å—Ç–Ω–∏–∫</span>
                <span id="room-id">{{ room_id }}</span>
            </div>
            <div class="user-profile">
                <span id="user-avatar" class="user-avatar">üòä</span>
                <span id="user-name" class="user-name">–í—ã</span>
                <div class="user-status">
                    <span class="status-indicator" id="user-status-indicator"></span>
                    <span id="user-status-text">–í —Å–µ—Ç–∏</span>
                </div>
                <button id="copy-link">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è—Ö -->
        <div id="permissions-banner" class="permissions-banner" style="display: none;">
            <div class="banner-content">
                <span class="banner-icon">üé§</span>
                <span class="banner-text">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ä–µ—á–∏</span>
                <button id="request-permissions" class="banner-btn">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
                <button id="dismiss-banner" class="banner-dismiss">‚úï</button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="main-content">
            <!-- –í–∏–¥–µ–æ –æ–±–ª–∞—Å—Ç—å -->
            <div class="video-area">
                <div id="video-grid" class="video-grid mode-equal participants-1">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–ª–∏—Ç–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
                
                <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π -->
                <div class="reactions-overlay" id="reactions-overlay"></div>
                
                <!-- –ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ–∞–∫—Ü–∏–π -->
                <div class="quick-reactions" id="quick-reactions">
                    <button class="reaction-btn" onclick="sendReaction('üëç')">üëç</button>
                    <button class="reaction-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="reaction-btn" onclick="sendReaction('üòÇ')">üòÇ</button>
                    <button class="reaction-btn" onclick="sendReaction('üòÆ')">üòÆ</button>
                    <button class="reaction-btn" onclick="sendReaction('üëè')">üëè</button>
                    <button class="reaction-btn" onclick="sendReaction('üî•')">üî•</button>
                </div>
            </div>

            <!-- –ß–∞—Ç -->
            <div class="chat-container">
                <div class="chat-header">
                    –°–æ–æ–±—â–µ–Ω–∏—è
                </div>
                <div id="chat" class="chat"></div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key==='Enter') document.getElementById('send-message').click();">
                    <button id="send-message">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="controls">
            <button id="toggle-mic" class="control-btn mic active" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>
            <button id="toggle-camera" class="control-btn camera" title="–ö–∞–º–µ—Ä–∞">üìπ</button>
            <button id="toggle-screen" class="control-btn screen" title="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞">üñ•</button>
            <button id="toggle-reactions" class="control-btn reactions" title="–†–µ–∞–∫—Ü–∏–∏">üòä</button>
            <button id="toggle-audio" class="control-btn audio active" title="–ó–≤—É–∫">üîä</button>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
    <button id="start-video" style="display: none;"></button>
    <button id="stop-video" style="display: none;"></button>
    <button id="share-screen" style="display: none;"></button>
    <button id="stop-screen" style="display: none;"></button>
    <button id="mute-audio" style="display: none;"></button>
    <button id="unmute-audio" style="display: none;"></button>
    <button id="mute-mic" style="display: none;"></button>
    <button id="unmute-mic" style="display: none;"></button>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const ROOM_ID = "{{ room_id }}";
        
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
            name: '–ì–æ—Å—Ç—å',
            avatar: 'üòä'
        };
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–æ–∫–µ—Ç—É
        const socket = io();
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let reactionsVisible = false;
        let isSpeaking = false;
        let micStream = null;
        let audioContext = null;
        let analyser = null;
        let speechDetectionEnabled = false;
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
        let micEnabled = true;
        let cameraEnabled = false;
        let screenEnabled = false;
        let audioEnabled = true;
        
        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–µ–¥–∏–∞
        let localStream = null;
        let localVideoTrack = null;
        let localAudioTrack = null;
        let screenStream = null;
        let peerConnections = {};
        
        // –£—á–∞—Å—Ç–Ω–∏–∫–∏
        let participants = [];
        let presentingParticipant = null; // –ö—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getLocalVideoElement() {
            const container = document.getElementById(`participant-${userProfile.name}`);
            if (!container) return null;
            
            let video = container.querySelector('video');
            if (!video) {
                video = document.createElement('video');
                video.autoplay = true;
                video.muted = true; // –ó–∞–≥–ª—É—à–∞–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
                video.playsInline = true;
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                
                // –°–∫—Ä—ã–≤–∞–µ–º placeholder –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
                const placeholder = container.querySelector('.video-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
                container.appendChild(video);
            }
            return video;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤–∏–¥–µ–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        function getRemoteVideoElement(participantName) {
            const container = document.getElementById(`participant-${participantName}`);
            if (!container) return null;
            
            let video = container.querySelector('video');
            if (!video) {
                video = document.createElement('video');
                video.autoplay = true;
                video.playsInline = true;
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                
                // –°–∫—Ä—ã–≤–∞–µ–º placeholder –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
                const placeholder = container.querySelector('.video-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
                container.appendChild(video);
            }
            return video;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å placeholder –≤–º–µ—Å—Ç–æ –≤–∏–¥–µ–æ
        function showPlaceholder(participantName) {
            const container = document.getElementById(`participant-${participantName}`);
            if (!container) return;
            
            const video = container.querySelector('video');
            const placeholder = container.querySelector('.video-placeholder');
            
            if (video) {
                video.style.display = 'none';
            }
            if (placeholder) {
                placeholder.style.display = 'flex';
            }
        }

        // –°–∫—Ä—ã—Ç—å placeholder –∏ –ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ
        function hidePlaceholder(participantName) {
            const container = document.getElementById(`participant-${participantName}`);
            if (!container) return;
            
            const video = container.querySelector('video');
            const placeholder = container.querySelector('.video-placeholder');
            
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            if (video) {
                video.style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        async function startCamera() {
            try {
                console.log('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...');
                showSystemMessage('üìπ –í–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É...');
                
                // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å—Ç—Ä–∏–º —Å –∞—É–¥–∏–æ, –¥–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ
                if (localStream && localStream.getAudioTracks().length > 0) {
                    const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const videoTrack = videoStream.getVideoTracks()[0];
                    
                    localStream.addTrack(videoTrack);
                    localVideoTrack = videoTrack;
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å—Ç—Ä–∏–º —Å –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                    localVideoTrack = localStream.getVideoTracks()[0];
                    localAudioTrack = localStream.getAudioTracks()[0];
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–µ—Ç–µ–∫—Ü–∏—é —Ä–µ—á–∏ —Å –Ω–æ–≤—ã–º –∞—É–¥–∏–æ
                    if (!speechDetectionEnabled && localAudioTrack) {
                        setupSpeechDetection(localStream);
                    }
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–∏–¥–µ–æ –ª–æ–∫–∞–ª—å–Ω–æ
                const localVideo = getLocalVideoElement();
                if (localVideo) {
                    localVideo.srcObject = localStream;
                    hidePlaceholder(userProfile.name);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ peer connections
                for (const peerId in peerConnections) {
                    const pc = peerConnections[peerId];
                    if (localVideoTrack) {
                        pc.addTrack(localVideoTrack, localStream);
                    }
                }
                
                console.log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                showSystemMessage('‚úÖ –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞');
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                
                let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'üö´ –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â—ë–Ω';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'üìπ –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = '‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ';
                }
                
                showSystemMessage(errorMessage);
                return false;
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
        function stopCamera() {
            try {
                console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã...');
                
                if (localVideoTrack) {
                    localVideoTrack.stop();
                    
                    // –£–¥–∞–ª—è–µ–º —Ç—Ä–µ–∫ –∏–∑ —Å—Ç—Ä–∏–º–∞
                    if (localStream) {
                        localStream.removeTrack(localVideoTrack);
                    }
                    
                    // –£–¥–∞–ª—è–µ–º —Ç—Ä–µ–∫ –∏–∑ –≤—Å–µ—Ö peer connections
                    for (const peerId in peerConnections) {
                        const pc = peerConnections[peerId];
                        const senders = pc.getSenders();
                        const videoSender = senders.find(sender => 
                            sender.track && sender.track.kind === 'video'
                        );
                        if (videoSender) {
                            pc.removeTrack(videoSender);
                        }
                    }
                    
                    localVideoTrack = null;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
                showPlaceholder(userProfile.name);
                
                console.log('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                showSystemMessage('üìπ –ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–µ—Ä—ã:', error);
                showSystemMessage('‚ùå –û—à–∏–±–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã');
            }
        }

        // –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        async function startScreenShare() {
            try {
                console.log('–ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞...');
                showSystemMessage('üñ• –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞...');
                
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });
                
                const screenTrack = screenStream.getVideoTracks()[0];
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
                const localVideo = getLocalVideoElement();
                if (localVideo) {
                    localVideo.srcObject = screenStream;
                    hidePlaceholder(userProfile.name);
                }
                
                // –ó–∞–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ —Ç—Ä–µ–∫ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö connections
                for (const peerId in peerConnections) {
                    const pc = peerConnections[peerId];
                    const senders = pc.getSenders();
                    const videoSender = senders.find(sender => 
                        sender.track && sender.track.kind === 'video'
                    );
                    
                    if (videoSender) {
                        await videoSender.replaceTrack(screenTrack);
                    } else {
                        pc.addTrack(screenTrack, screenStream);
                    }
                }
                
                // –°–ª—É—à–∞–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å")
                screenTrack.onended = () => {
                    console.log('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                    screenEnabled = false;
                    updateButtonState('toggle-screen', false);
                    stopScreenShare();
                    updatePresentationStatus(userProfile.name, false);
                    
                    socket.emit('screen_status', {
                        room: ROOM_ID,
                        enabled: false,
                        profile: userProfile
                    });
                };
                
                console.log('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–ø—É—â–µ–Ω–∞');
                showSystemMessage('‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞');
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                
                let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'üö´ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = '‚ö†Ô∏è –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                }
                
                showSystemMessage(errorMessage);
                return false;
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        async function stopScreenShare() {
            try {
                console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞...');
                
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    screenStream = null;
                }
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∫–∞–º–µ—Ä–µ, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –≤–∫–ª—é—á–µ–Ω–∞
                if (cameraEnabled && localVideoTrack) {
                    const localVideo = getLocalVideoElement();
                    if (localVideo && localStream) {
                        localVideo.srcObject = localStream;
                    }
                    
                    // –ó–∞–º–µ–Ω—è–µ–º —Ç—Ä–µ–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–∞–º–µ—Ä—É –≤ connections
                    for (const peerId in peerConnections) {
                        const pc = peerConnections[peerId];
                        const senders = pc.getSenders();
                        const videoSender = senders.find(sender => 
                            sender.track && sender.track.kind === 'video'
                        );
                        
                        if (videoSender && localVideoTrack) {
                            await videoSender.replaceTrack(localVideoTrack);
                        }
                    }
                } else {
                    // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
                    showPlaceholder(userProfile.name);
                }
                
                console.log('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                showSystemMessage('üñ• –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showSystemMessage('‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏');
            }
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        async function startMicrophone() {
            try {
                console.log('–í–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...');
                
                if (!localStream) {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å—Ç—Ä–∏–º —Ç–æ–ª—å–∫–æ —Å –∞—É–¥–∏–æ
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true,
                        video: false 
                    });
                    localAudioTrack = localStream.getAudioTracks()[0];
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–µ—Ç–µ–∫—Ü–∏—é —Ä–µ—á–∏
                    if (!speechDetectionEnabled) {
                        setupSpeechDetection(localStream);
                    }
                } else if (!localAudioTrack) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Å—Ç—Ä–∏–º—É
                    const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const audioTrack = audioStream.getAudioTracks()[0];
                    
                    localStream.addTrack(audioTrack);
                    localAudioTrack = audioTrack;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–µ–∫—Ü–∏—é —Ä–µ—á–∏
                    if (!speechDetectionEnabled) {
                        setupSpeechDetection(localStream);
                    }
                } else {
                    // –ú–∏–∫—Ä–æ—Ñ–æ–Ω —É–∂–µ –≤–∫–ª—é—á–µ–Ω, –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–º—É—á–∏–≤–∞–µ–º
                    localAudioTrack.enabled = true;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ —Ç—Ä–µ–∫ –≤–æ –≤—Å–µ connections
                for (const peerId in peerConnections) {
                    const pc = peerConnections[peerId];
                    if (localAudioTrack) {
                        const audioSender = pc.getSenders().find(sender => 
                            sender.track && sender.track.kind === 'audio'
                        );
                        if (!audioSender) {
                            pc.addTrack(localAudioTrack, localStream);
                        }
                    }
                }
                
                console.log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω');
                showSystemMessage('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω');
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
                
                let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'üö´ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
                }
                
                showSystemMessage(errorMessage);
                return false;
            }
        }

        // –í—ã–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        function stopMicrophone() {
            try {
                console.log('–í—ã–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...');
                
                if (localAudioTrack) {
                    localAudioTrack.enabled = false; // –ú—É—Ç–∏–º –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
                }
                
                console.log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
                showSystemMessage('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
                showSystemMessage('‚ùå –û—à–∏–±–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ peer connection
        function createPeerConnection(peerId) {
            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[peerId] = pc;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–µ–∫–æ–≤
            pc.ontrack = (event) => {
                console.log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫:', event.track.kind);
                const remoteStream = event.streams[0];
                
                // –ù–∞—Ö–æ–¥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ ID –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–≥–æ –≤–∏–¥–µ–æ
                // –ó–¥–µ—Å—å –Ω—É–∂–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è peerId —Å –∏–º–µ–Ω–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
                // –ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
                console.log('–£–¥–∞–ª–µ–Ω–Ω—ã–π —Å—Ç—Ä–∏–º –æ—Ç:', peerId, remoteStream);
            };
            
            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        candidate: event.candidate,
                        to: peerId,
                        room: ROOM_ID
                    });
                }
            };
            
            return pc;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateUserProfile() {
            document.getElementById('user-name').textContent = userProfile.name;
            document.getElementById('user-avatar').textContent = userProfile.avatar;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function updateParticipantsCount(count) {
            const countElement = document.getElementById('participants-count');
            const word = count === 1 ? '—É—á–∞—Å—Ç–Ω–∏–∫' : count < 5 ? '—É—á–∞—Å—Ç–Ω–∏–∫–∞' : '—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤';
            countElement.textContent = `‚Äî ${count} ${word}`;
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ —Å–µ—Ç–∫—É
        function addParticipantToGrid(participant) {
            const videoGrid = document.getElementById('video-grid');
            const participantContainer = document.createElement('div');
            participantContainer.className = 'video-container';
            participantContainer.id = `participant-${participant.name}`;
            
            participantContainer.innerHTML = `
                <div class="video-placeholder">
                    <span class="placeholder-avatar">${participant.avatar}</span>
                    <span class="placeholder-name">${participant.name}</span>
                </div>
                <div class="video-status">
                    <div class="status-badge camera-off">üìπ –ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª.</div>
                </div>
                <div class="participant-info">
                    <div class="participant-name-info">
                        <span class="participant-avatar-small">${participant.avatar}</span>
                        <span class="participant-name-text">${participant.name}</span>
                    </div>
                    <div class="participant-status-indicators">
                        <span class="status-icon" id="mic-${participant.name}">üé§</span>
                        <span class="status-icon" id="cam-${participant.name}">üìπ</span>
                    </div>
                </div>
            `;
            
            videoGrid.appendChild(participantContainer);
            updateGridLayout();
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ —Å–µ—Ç–∫–∏
        function removeParticipantFromGrid(participantName) {
            const participantContainer = document.getElementById(`participant-${participantName}`);
            if (participantContainer) {
                participantContainer.remove();
            }
            updateGridLayout();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∫–∏ —Å–µ—Ç–∫–∏
        function updateGridLayout() {
            const videoGrid = document.getElementById('video-grid');
            const participantCount = participants.length;
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ —Ä–µ–∂–∏–º–æ–≤
            videoGrid.className = 'video-grid';
            
            if (presentingParticipant) {
                // –†–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                videoGrid.classList.add('mode-presentation');
                
                // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ—Ç–∫—É –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                const containers = videoGrid.querySelectorAll('.video-container');
                containers.forEach(container => {
                    container.classList.remove('main-presenter', 'sidebar-participant');
                });
                
                // –ü—Ä–µ–∑–µ–Ω—Ç—É—é—â–∏–π —É—á–∞—Å—Ç–Ω–∏–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≥–ª–∞–≤–Ω—ã–º
                const presenterContainer = document.getElementById(`participant-${presentingParticipant.name}`);
                if (presenterContainer) {
                    presenterContainer.classList.add('main-presenter');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å-–±–µ–π–¥–∂ –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                    const statusContainer = presenterContainer.querySelector('.video-status');
                    if (!statusContainer.querySelector('.status-badge.presenting')) {
                        const presentingBadge = document.createElement('div');
                        presentingBadge.className = 'status-badge presenting';
                        presentingBadge.textContent = 'üñ• –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞';
                        statusContainer.appendChild(presentingBadge);
                    }
                }
                
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤ –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
                containers.forEach(container => {
                    if (!container.classList.contains('main-presenter')) {
                        container.classList.add('sidebar-participant');
                    }
                });
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –±–æ–∫–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                if (!videoGrid.querySelector('.sidebar-participants')) {
                    const sidebarContainer = document.createElement('div');
                    sidebarContainer.className = 'sidebar-participants';
                    
                    containers.forEach(container => {
                        if (container.classList.contains('sidebar-participant')) {
                            sidebarContainer.appendChild(container);
                        }
                    });
                    
                    videoGrid.appendChild(sidebarContainer);
                }
                
            } else {
                // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è —Å–µ—Ç–∫–∞
                videoGrid.classList.add('mode-equal');
                videoGrid.classList.add(`participants-${participantCount}`);
                
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã
                const containers = videoGrid.querySelectorAll('.video-container');
                containers.forEach(container => {
                    container.classList.remove('main-presenter', 'sidebar-participant');
                    
                    // –£–¥–∞–ª—è–µ–º –±–µ–π–¥–∂ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                    const presentingBadge = container.querySelector('.status-badge.presenting');
                    if (presentingBadge) {
                        presentingBadge.remove();
                    }
                });
                
                // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ–∫–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                const sidebarContainer = videoGrid.querySelector('.sidebar-participants');
                if (sidebarContainer) {
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Å–µ—Ç–∫—É
                    const sidebarParticipants = sidebarContainer.querySelectorAll('.video-container');
                    sidebarParticipants.forEach(container => {
                        videoGrid.appendChild(container);
                    });
                    sidebarContainer.remove();
                }
            }
            
            console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ—Ç–∫–∞: ${participantCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è: ${presentingParticipant ? '–¥–∞' : '–Ω–µ—Ç'}`);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function updateParticipantsList(participantProfiles) {
            const videoGrid = document.getElementById('video-grid');
            
            // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            participantProfiles.forEach(profile => {
                if (!participants.find(p => p.name === profile.name)) {
                    participants.push({
                        name: profile.name,
                        avatar: profile.avatar,
                        speaking: false,
                        cameraEnabled: false,
                        micEnabled: true
                    });
                    addParticipantToGrid(profile);
                }
            });
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∫–∏–Ω—É–≤—à–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            participants = participants.filter(participant => {
                const stillHere = participantProfiles.find(p => p.name === participant.name);
                if (!stillHere) {
                    removeParticipantFromGrid(participant.name);
                    // –ï—Å–ª–∏ –ø—Ä–µ–∑–µ–Ω—Ç—É—é—â–∏–π –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É, –≤—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                    if (presentingParticipant && presentingParticipant.name === participant.name) {
                        presentingParticipant = null;
                        updateGridLayout();
                    }
                }
                return stillHere;
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≥–æ–≤–æ—Ä–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
        function updateParticipantSpeaking(profileName, speaking) {
            const participant = participants.find(p => p.name === profileName);
            if (participant) {
                participant.speaking = speaking;
                
                const container = document.getElementById(`participant-${profileName}`);
                const micIcon = document.getElementById(`mic-${profileName}`);
                
                if (container && micIcon) {
                    if (speaking) {
                        container.classList.add('speaking');
                        micIcon.classList.add('speaking', 'active');
                    } else {
                        container.classList.remove('speaking');
                        micIcon.classList.remove('speaking');
                    }
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
        function updatePresentationStatus(profileName, isPresenting) {
            if (isPresenting) {
                const participant = participants.find(p => p.name === profileName);
                if (participant) {
                    presentingParticipant = participant;
                    showSystemMessage(`üñ• ${participant.name} –Ω–∞—á–∞–ª –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞`);
                }
            } else {
                if (presentingParticipant && presentingParticipant.name === profileName) {
                    showSystemMessage(`üñ• ${presentingParticipant.name} –∑–∞–≤–µ—Ä—à–∏–ª –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞`);
                    presentingParticipant = null;
                }
            }
            updateGridLayout();
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC
        function checkWebRTCSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.log('WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                showSystemMessage('‚ö†Ô∏è –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–µ—Ç–µ–∫—Ü–∏—é —Ä–µ—á–∏');
                return false;
            }
            return true;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showSystemMessage(text) {
            displayMessage({
                msg: text,
                author: '–°–∏—Å—Ç–µ–º–∞',
                avatar: '‚öôÔ∏è',
                timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–Ω–Ω–µ—Ä —Å –∑–∞–ø—Ä–æ—Å–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        function showPermissionsBanner() {
            const banner = document.getElementById('permissions-banner');
            banner.style.display = 'block';
            
            setTimeout(() => {
                if (banner.style.display !== 'none') {
                    banner.style.display = 'none';
                }
            }, 10000);
        }
        
        // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω
        async function requestMicrophonePermission() {
            if (!checkWebRTCSupport()) return false;
            
            try {
                console.log('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                showSystemMessage('üé§ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: false 
                });
                
                console.log('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω');
                showSystemMessage('‚úÖ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É —Ä–∞–∑—Ä–µ—à—ë–Ω');
                setupSpeechDetection(stream);
                document.getElementById('permissions-banner').style.display = 'none';
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                
                let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'üö´ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = '‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                }
                
                showSystemMessage(errorMessage);
                document.getElementById('permissions-banner').style.display = 'none';
                return false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ä–µ—á–∏
        function setupSpeechDetection(stream) {
            try {
                micStream = stream;
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.3;
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                speechDetectionEnabled = true;
                
                console.log('–î–µ—Ç–µ–∫—Ü–∏—è —Ä–µ—á–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                showSystemMessage('üéß –î–µ—Ç–µ–∫—Ü–∏—è —Ä–µ—á–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
                
                function detectSpeech() {
                    if (!analyser || !speechDetectionEnabled) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / dataArray.length;
                    
                    const wasSpeaking = isSpeaking;
                    isSpeaking = average > 25 && micEnabled;
                    
                    if (wasSpeaking !== isSpeaking) {
                        updateSpeakingStatus(isSpeaking);
                        updateParticipantSpeaking(userProfile.name, isSpeaking);
                    }
                    
                    requestAnimationFrame(detectSpeech);
                }
                
                detectSpeech();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ä–µ—á–∏:', error);
                showSystemMessage('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ä–µ—á–∏');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≥–æ–≤–æ—Ä–µ–Ω–∏—è
        function updateSpeakingStatus(speaking) {
            const micBtn = document.getElementById('toggle-mic');
            const statusIndicator = document.getElementById('user-status-indicator');
            const statusText = document.getElementById('user-status-text');
            
            if (speaking && micEnabled) {
                micBtn.classList.add('speaking');
                statusIndicator.classList.add('speaking');
                statusIndicator.classList.remove('muted', 'online');
                statusText.textContent = '–ì–æ–≤–æ—Ä–∏—Ç';
                
                socket.emit('speaking_status', {
                    room: ROOM_ID,
                    speaking: true,
                    profile: userProfile
                });
            } else {
                micBtn.classList.remove('speaking');
                statusIndicator.classList.remove('speaking');
                
                if (!micEnabled) {
                    statusIndicator.classList.add('muted');
                    statusIndicator.classList.remove('online');
                    statusText.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª.';
                } else {
                    statusIndicator.classList.add('online');
                    statusIndicator.classList.remove('muted');
                    statusText.textContent = '–í —Å–µ—Ç–∏';
                }
                
                socket.emit('speaking_status', {
                    room: ROOM_ID,
                    speaking: false,
                    profile: userProfile
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage(text) {
            const messageData = {
                msg: text,
                room: ROOM_ID,
                author: userProfile.name,
                avatar: userProfile.avatar,
                timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            };
            socket.emit('message', messageData);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∞–∫—Ü–∏–∏
        function sendReaction(emoji) {
            const reactionData = {
                emoji: emoji,
                room: ROOM_ID,
                author: userProfile.name,
                avatar: userProfile.avatar,
                timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            };
            socket.emit('reaction', reactionData);
            toggleReactions();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        function showReactionAnimation(data) {
            const overlay = document.getElementById('reactions-overlay');
            const reactionElement = document.createElement('div');
            reactionElement.className = 'reaction-emoji';
            reactionElement.textContent = data.emoji;
            
            const randomX = Math.random() * 80 + 10;
            const randomY = Math.random() * 60 + 20;
            
            reactionElement.style.left = randomX + '%';
            reactionElement.style.top = randomY + '%';
            
            overlay.appendChild(reactionElement);
            
            setTimeout(() => {
                if (reactionElement.parentNode) {
                    reactionElement.parentNode.removeChild(reactionElement);
                }
            }, 3000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        function displayMessage(data) {
            const chat = document.getElementById('chat');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="message-avatar">${data.avatar || 'üòä'}</span>
                    <span class="message-author">${data.author || '–ì–æ—Å—Ç—å'}</span>
                    <span class="message-time">${data.timestamp || ''}</span>
                </div>
                <div class="message-text">${data.msg}</div>
            `;
            
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–µ–∞–∫—Ü–∏–∏
        function displayReactionMessage(data) {
            const chat = document.getElementById('chat');
            const messageElement = document.createElement('div');
            messageElement.className = 'message reaction';
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="message-avatar">${data.avatar || 'üòä'}</span>
                    <span class="message-author">${data.author || '–ì–æ—Å—Ç—å'}</span>
                    <span class="message-time">${data.timestamp || ''}</span>
                </div>
                <div class="message-text">–†–µ–∞–∫—Ü–∏—è: ${data.emoji}</div>
            `;
            
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Ä–µ–∞–∫—Ü–∏–π
        function toggleReactions() {
            const reactionsPanel = document.getElementById('quick-reactions');
            const reactionsBtn = document.getElementById('toggle-reactions');
            
            reactionsVisible = !reactionsVisible;
            
            if (reactionsVisible) {
                reactionsPanel.classList.add('show');
                reactionsBtn.classList.add('active');
            } else {
                reactionsPanel.classList.remove('show');
                reactionsBtn.classList.remove('active');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('request-permissions').addEventListener('click', requestMicrophonePermission);
        document.getElementById('dismiss-banner').addEventListener('click', () => {
            document.getElementById('permissions-banner').style.display = 'none';
        });
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏ —Å –Ω–æ–≤—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏
        document.getElementById('toggle-mic').addEventListener('click', async () => {
            if (micEnabled) {
                stopMicrophone();
            } else {
                const success = await startMicrophone();
                if (!success) {
                    return;
                }
            }
            micEnabled = !micEnabled;
            updateButtonState('toggle-mic', micEnabled);
            updateSpeakingStatus(false);
            
            socket.emit('mic_status', {
                room: ROOM_ID,
                enabled: micEnabled,
                profile: userProfile
            });
        });

        document.getElementById('toggle-camera').addEventListener('click', async () => {
            if (cameraEnabled) {
                stopCamera();
            } else {
                const success = await startCamera();
                if (!success) {
                    return;
                }
            }
            cameraEnabled = !cameraEnabled;
            updateButtonState('toggle-camera', cameraEnabled);
            
            socket.emit('camera_status', {
                room: ROOM_ID,
                enabled: cameraEnabled,
                profile: userProfile
            });
        });

        document.getElementById('toggle-screen').addEventListener('click', async () => {
            if (screenEnabled) {
                await stopScreenShare();
                updatePresentationStatus(userProfile.name, false);
            } else {
                const success = await startScreenShare();
                if (!success) {
                    return;
                }
                updatePresentationStatus(userProfile.name, true);
            }
            screenEnabled = !screenEnabled;
            updateButtonState('toggle-screen', screenEnabled);
            
            socket.emit('screen_status', {
                room: ROOM_ID,
                enabled: screenEnabled,
                profile: userProfile
            });
        });

        document.getElementById('toggle-audio').addEventListener('click', () => {
            if (audioEnabled) {
                document.getElementById('mute-audio').click();
            } else {
                document.getElementById('unmute-audio').click();
            }
            audioEnabled = !audioEnabled;
            updateButtonState('toggle-audio', audioEnabled);
        });

        document.getElementById('toggle-reactions').addEventListener('click', toggleReactions);

        function updateButtonState(buttonId, isActive) {
            const btn = document.getElementById(buttonId);
            if (isActive) {
                btn.classList.add('active');
                btn.classList.remove('muted');
            } else {
                btn.classList.remove('active');
                if (buttonId === 'toggle-mic' || buttonId === 'toggle-audio') {
                    btn.classList.add('muted');
                }
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('send-message').addEventListener('click', () => {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (message) {
                sendMessage(message);
                input.value = '';
            }
        });

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        document.getElementById('copy-link').addEventListener('click', () => {
            const link = window.location.href;
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.getElementById('copy-link');
                const originalText = btn.textContent;
                btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ —Ä–µ–∞–∫—Ü–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
        document.addEventListener('click', (e) => {
            const reactionsPanel = document.getElementById('quick-reactions');
            const reactionsBtn = document.getElementById('toggle-reactions');
            
            if (reactionsVisible && !reactionsPanel.contains(e.target) && e.target !== reactionsBtn) {
                toggleReactions();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–∫–µ—Ç–æ–≤
        socket.on('connect', () => {
            console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–æ–∫–µ—Ç—É');
            socket.emit('join', {
                room: ROOM_ID,
                profile: userProfile
            });
        });
        
        socket.on('message', (data) => {
            displayMessage(data);
        });
        
        socket.on('reaction', (data) => {
            showReactionAnimation(data);
            displayReactionMessage(data);
        });
        
        socket.on('speaking_status', (data) => {
            updateParticipantSpeaking(data.profile.name, data.speaking);
        });
        
        socket.on('camera_status', (data) => {
            console.log('–°—Ç–∞—Ç—É—Å –∫–∞–º–µ—Ä—ã –∏–∑–º–µ–Ω—ë–Ω:', data);
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–º–µ—Ä—ã —É—á–∞—Å—Ç–Ω–∏–∫–∞
        });
        
        socket.on('screen_status', (data) => {
            console.log('–°—Ç–∞—Ç—É—Å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏–∑–º–µ–Ω—ë–Ω:', data);
            updatePresentationStatus(data.profile.name, data.enabled);
        });
        
        socket.on('mic_status', (data) => {
            console.log('–°—Ç–∞—Ç—É—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏–∑–º–µ–Ω—ë–Ω:', data);
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        });
        
        socket.on('user_joined', (data) => {
            updateParticipantsCount(data.participants_count);
            displayMessage({
                msg: `${data.profile.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –≤—Å—Ç—Ä–µ—á–µ`,
                author: '–°–∏—Å—Ç–µ–º–∞',
                avatar: 'üîî',
                timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            });
        });
        
        socket.on('user_left', (data) => {
            updateParticipantsCount(data.participants_count);
            displayMessage({
                msg: `${data.profile.name} –ø–æ–∫–∏–Ω—É–ª –≤—Å—Ç—Ä–µ—á—É`,
                author: '–°–∏—Å—Ç–µ–º–∞',
                avatar: 'üëã',
                timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            });
        });
        
        socket.on('participants_update', (data) => {
            updateParticipantsCount(data.count);
            updateParticipantsList(data.participants);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateUserProfile();
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –∫–∞–∫ –ø–µ—Ä–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        participants.push({
            name: userProfile.name,
            avatar: userProfile.avatar,
            speaking: false,
            cameraEnabled: false,
            micEnabled: true
        });
        addParticipantToGrid(userProfile);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä —Å –∑–∞–ø—Ä–æ—Å–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (checkWebRTCSupport()) {
                showPermissionsBanner();
            }
        }, 2000);

        console.log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ: ${ROOM_ID} –∫–∞–∫ ${userProfile.name} ${userProfile.avatar}`);
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>